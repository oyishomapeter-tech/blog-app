<!DOCTYPE html>
<html lang="en">
<%- include('partials/header') %>
<body>
  <div class="page-wrapper">
    <!-- Welcome banner: hidden by default. Will flash briefly after login when ?welcome=1 is present
         or when sessionStorage.showWelcome === '1' (so server can set that via a small script on login page).
    -->
    <section id="welcome-banner" class="welcome-banner hidden">
      <span class="emoji">üëã</span>
      <div>
        <h2>
          Welcome back, <%= user && user.firstname ? user.firstname : 'Guest' %>!
        </h2>
        <p>Ready to discover amazing articles today?</p>
      </div>
      <div class="banner-logout-div">
          <button type="submit" class="logout-btn">
            <a href="/logout">Logout</a>
          </button>
      </div>
    </section>
    </section>

    <script>
      // Show the welcome banner briefly when redirected after login.
      (function(){
        try {
          var params = new URLSearchParams(window.location.search);
          var show = params.get('welcome') === '1' || sessionStorage.getItem('showWelcome') === '1';
          if (show) {
            var banner = document.getElementById('welcome-banner');
            if (banner) {
              // show with animation class
              banner.classList.remove('hidden');
              banner.classList.add('flash');
              // clear the session flag so it only shows once
              sessionStorage.removeItem('showWelcome');
              // remove the welcome query param from URL (clean URL)
              if (params.has('welcome')) {
                params.delete('welcome');
                var newUrl = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '') + window.location.hash;
                window.history.replaceState({}, document.title, newUrl);
              }
              // hide after animation duration (4s) + small buffer
              setTimeout(function(){
                banner.classList.remove('flash');
                banner.classList.add('hidden');
              }, 4200);
            }
          }
        } catch (e) {
          // fail silently
          console.error(e);
        }
      })();
    </script>

<div class="main-content">
      <!-- Left Sidebar -->
      <aside class="sidebar">
        <!-- Categories Section -->
        <div class="sidebar-section categories-section">
          <h3>Categories</h3>
          <ul class="categories-list">
            <li><a href="/blogs?category=technology">Technology</a></li>
            <li><a href="/blogs?category=lifestyle">Lifestyle</a></li>
            <li><a href="/blogs?category=business">Business</a></li>
            <li><a href="/blogs?category=health">Health</a></li>
            <li><a href="/blogs?category=travel">Travel</a></li>
            <li><a href="/blogs?category=other">Other</a></li>
          </ul>
        </div>

        <!-- Trending Posts Section -->
        <div class="sidebar-section trending-section">
          <h3>Trending Posts</h3>
          <% if(blogs && blogs.length > 0) { %>
            <ul class="trending-list">
              <% blogs.slice(0, 5).forEach(blog => { %>
                <li class="trending-item">
                  <a href="/blogs/<%= blog._id %>" class="trending-link">
                    <span class="trending-title"><%= blog.title %></span>
                    <span class="trending-author">By <%= blog.author && blog.author.firstname ? blog.author.firstname : 'Unknown' %></span>
                  </a>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="no-trending">No trending posts yet</p>
          <% } %>
        </div>
      </aside>
  
  <!-- Blog cards -->
  <div class="blog-body">
      <div class="blogs-toolbar">
        
        <div class="search-wrapper">
          <h2 class="all-blogs">All Blogs</h2>
          <form action="/blogs" method="get" class="search-form" role="search" aria-label="Search blogs">
            <input
              type="text"
              name="q"
              class="search-input"
              placeholder="Search articles, tags or authors..."
              value="<%= typeof q !== 'undefined' ? q : '' %>"
              aria-label="Search blogs"
            />
            <button type="submit" class="search-btn" aria-label="Submit search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
      <div class="blogs-grid">
        <% if(blogs.length > 0) { %>
          <% blogs.forEach(blog =>{ %>
            <% let _img = null;
               if (blog.imageUrl) { _img = blog.imageUrl; }
               else if (blog.body) {
                 var m = blog.body.match(/<img[^>]+src=["']([^"']+)["']/i);
                 if (m) _img = m[1];
               }
            %>
            <a href="/blogs/<%= blog._id %>" class="single">
              <% if(_img) { %>
                <div class="card-image">
                  <img src="<%= _img %>" alt="<%= blog.title %>">
                </div>
              <% } %>
              <div class="card-content">
                <h3 class="blog-title"><%= blog.title %></h3>
                <p class="blog-snippet"><%= blog.snippet %></p>
                <div class="card-footer">
                  <div class="card-meta-row">
                    <p class="blog-meta">By: <%= blog.author 
                      && blog.author.firstname 
                      && blog.author.lastname 
                      ? blog.author.firstname + ' ' + blog.author.lastname 
                      : 'Unknown' %>
                    </p>
                    <% if (user && blog.author && user._id.toString() !== blog.author._id.toString()) { %>
                      <button class="btn-follow-card <% if (blog.isFollowing) { %>following<% } %>" data-user-id="<%= blog.author._id %>" data-username="<%= blog.author.firstname %>"><% if (blog.isFollowing) { %>Following<% } else { %>Follow<% } %></button>
                    <% } %>
                  </div>
                </div>
                <div class="card-stats">
                  <span class="stat likes">‚ù§ <%= blog.likes ? blog.likes.length : 0 %></span>
                  <span class="stat comments">üí¨ <%= blog.comments ? blog.comments.length : 0 %></span>
                  <span class="stat shares">üîó <%= blog.shares || 0 %></span>
                </div>
              </div>
            </a>
          <% }) %>
        <% }else { %>
          <p class="no-blog">No blog post yet</p>
        <% } %>
      </div>     
    </div>
  </div>
  
  <!-- Server-side pagination controls -->
    <nav class="pagination" aria-label="Pagination">
      <% if (typeof currentPage !== 'undefined' && currentPage > 1) { %>
        <a href="/blogs?page=<%= currentPage - 1 %>" class="page-btn prev">Previous</a>
      <% } %>
      <% if (typeof currentPage !== 'undefined' && typeof totalPages !== 'undefined' && currentPage < totalPages) { %>
        <a href="/blogs?page=<%= currentPage + 1 %>" class="page-btn next">View more</a>
      <% } %>
    </nav>
  <%- include('partials/footer') %>
  </div>

  <script>
    // Follow button handler for blog cards
    (function(){
      const followBtns = document.querySelectorAll('.btn-follow-card');
      followBtns.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          try {
            const userId = btn.getAttribute('data-user-id');
            const username = btn.getAttribute('data-username');
            btn.disabled = true;
            const res = await fetch(`/users/${userId}/follow`, { method: 'POST' });
            const data = await res.json();
            if (res.ok) {
              if (data.following) {
                btn.classList.add('following');
                btn.textContent = 'Following';
              } else {
                btn.classList.remove('following');
                btn.textContent = 'Follow';
              }
            } else {
              alert(data.error || 'Could not follow user');
            }
          } catch (err) {
            console.error(err);
            alert('Network error');
          } finally {
            btn.disabled = false;
          }
        });
      });
    })();
  </script>
  
</body>
</html>