<!DOCTYPE html>
<html lang="en">
<%- include('partials/header') %>
<body>
  <div class="page-wrapper">
    <div class="profile-container">
      <!-- Hero Section: Profile Image, Name, Member Since, Bio -->
      <div class="profile-hero-section">
        <div class="hero-background"></div>
        <div class="hero-content">
          <div class="hero-avatar">
            <% 
              const firstChar = user && user.firstname ? user.firstname.charAt(0) : '';
              const lastChar = user && user.lastname ? user.lastname.charAt(0) : '';
              const initials = (firstChar + lastChar).toUpperCase() || 'U';
            %>
            <%= initials %>
          </div>
          <div class="hero-info">
            <h1 class="hero-name"><%= user.firstname %> <%= user.lastname || '' %></h1>
            <p class="hero-email"><%= user.email %></p>
            <p class="hero-member-since">Member since <strong><%= new Date(user.createdAt || Date.now()).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }) %></strong></p>
            <% if (user.bio) { %>
              <p class="hero-bio"><%= user.bio %></p>
            <% } %>
          </div>
          <a href="/profile/edit" class="btn-edit-profile">Edit Profile</a>
        </div>
      </div>

      <!-- Stats Section: Posts, Followers, Following -->
      <div class="profile-stats-section">
        <div class="stat-card">
          <div class="stat-number"><%= blogs && blogs.length || 0 %></div>
          <div class="stat-label">Posts</div>
        </div>
        <div class="stat-card">
          <div class="stat-number"><%= user.followers ? user.followers.length : 0 %></div>
          <div class="stat-label">Followers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number"><%= user.following ? user.following.length : 0 %></div>
          <div class="stat-label">Following</div>
        </div>
      </div>

      <!-- Content Sections: Personal Info, About Me, My Posts -->
      <div class="profile-content-sections">
        <!-- Personal Information Section -->
        <div class="profile-section">
          <h2 class="section-title">Personal Information</h2>
          <div class="section-content">
            <div class="info-grid">
              <div class="info-item">
                <label>First Name</label>
                <p><%= user.firstname %></p>
              </div>
              <div class="info-item">
                <label>Last Name</label>
                <p><%= user.lastname || 'Not provided' %></p>
              </div>
              <div class="info-item">
                <label>Email</label>
                <p><%= user.email %></p>
              </div>
              <div class="info-item">
                <label>Member Since</label>
                <p><%= new Date(user.createdAt || Date.now()).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
              </div>
            </div>
            <a href="/profile/edit" class="btn-edit-info">Edit Information</a>
          </div>
        </div>

        <!-- About Me Section -->
        <div class="profile-section">
          <h2 class="section-title">About Me</h2>
          <div class="section-content">
            <% if (user.bio) { %>
              <p class="about-text"><%= user.bio %></p>
            <% } else { %>
              <p class="about-empty">Tell us about yourself. <a href="/profile/edit">Add bio</a></p>
            <% } %>
            <a href="/profile/edit" class="btn-edit-about">Edit About</a>
          </div>
        </div>
      </div>

      <!-- My Posts Section -->
      <div class="profile-posts-section">
        <h2 class="section-title">My Posts</h2>
        
        <% if (blogs && blogs.length > 0) { %>
          <div class="profile-blogs-grid">
            <% blogs.forEach(blog => { %>
              <% let _img = null;
                 if (blog.imageUrl) { _img = blog.imageUrl; }
                 else if (blog.body) {
                   var m = blog.body.match(/<img[^>]+src=["']([^"']+)["']/i);
                   if (m) _img = m[1];
                 }
              %>
              <div class="profile-blog-card">
                <% if (_img) { %>
                  <div class="profile-card-image">
                    <img src="<%= _img %>" alt="<%= blog.title %>">
                  </div>
                <% } %>
                <div class="profile-card-content">
                  <h3 class="profile-blog-title"><%= blog.title %></h3>
                  <p class="profile-blog-snippet"><%= blog.snippet %></p>
                  <p class="profile-blog-date"><%= new Date(blog.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></p>
                </div>
                <div class="profile-card-actions">
                  <a href="/blogs/<%= blog._id %>" class="btn-view">View</a>
                  <a href="/blogs/<%= blog._id %>/edit" class="btn-edit">Edit</a>
                  <button class="btn-delete" data-id="<%= blog._id %>">Delete</button>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <div class="no-posts-message">
            <p>You haven't published any posts yet.</p>
            <a href="/new-post" class="btn-create-post-secondary">Create Your First Post</a>
          </div>
        <% } %>
      </div>
    </div>

    <%- include('partials/footer') %>
  </div>

  <script>
    // delete post functionality
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        const blogId = btn.getAttribute('data-id');
        try {
          const res = await fetch(`/blogs/${blogId}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.redirect) window.location.href = data.redirect;
        } catch (err) {
          console.error('Error deleting blog:', err);
          alert('Failed to delete post');
        }
      });
    });
  </script>
</body>
</html>
