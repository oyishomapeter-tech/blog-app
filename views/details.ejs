<!DOCTYPE html>
<html lang="en">
<%- include('partials/header') %>
<body>
  <div class="page-wrapper">
    <% if (blog) { %>
      <!-- Hero Article Header -->
      <div class="article-hero-section">
        <div class="article-hero-bg"></div>
        <div class="article-hero-content">
          <h1 class="article-title"><%= blog.title %></h1>
          <div class="article-meta">
            <div class="author-info">
              <div class="author-avatar">
                <% if (blog.author) { %>
                  <%= (blog.author.firstname.charAt(0) + (blog.author.lastname ? blog.author.lastname.charAt(0) : '')).toUpperCase() %>
                <% } else { %>
                  A
                <% } %>
              </div>
              <div class="author-details">
                <p class="author-name">
                  <% if (blog.author) { %>
                    <%= blog.author.firstname %> <%= blog.author.lastname || '' %>
                  <% } else { %>
                    Anonymous
                  <% } %>
                </p>
                <p class="article-date">
                  <%= new Date(blog.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                </p>
              </div>
            </div>
            <div class="article-read-time">
              <span class="read-time-badge"><%= Math.ceil(blog.body.split(/\s+/).length / 200) %> min read</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="article-container">
        <!-- Article Body (Left) -->
        <article class="article-content">
          <!-- Featured Image (if available) -->
          <% 
            let featuredImg = null;
            if (blog.imageUrl) { 
              featuredImg = blog.imageUrl; 
            } else if (blog.body) {
              var m = blog.body.match(/<img[^>]+src=["']([^"']+)["']/i);
              if (m) featuredImg = m[1];
            }
          %>
          <% if (featuredImg) { %>
            <figure class="article-featured-image">
              <img src="<%= featuredImg %>" alt="<%= blog.title %>">
            </figure>
          <% } %>

          <!-- Article Body -->
          <div class="article-body">
            <%- blog.body %>
          </div>

          <!-- Article Footer -->
          <div class="article-footer">
            <div class="article-tags">
              <% if (blog.tags && blog.tags.length > 0) { %>
                <h4>Tags</h4>
                <div class="tags-list">
                  <% blog.tags.forEach(tag => { %>
                    <span class="tag"><%= tag %></span>
                  <% }) %>
                </div>
              <% } %>
            </div>

            <!-- Author Bio Section -->
            <div class="author-bio-section">
              <div class="author-bio-card">
                <div class="author-bio-avatar">
                  <% if (blog.author) { %>
                    <%= (blog.author.firstname.charAt(0) + (blog.author.lastname ? blog.author.lastname.charAt(0) : '')).toUpperCase() %>
                  <% } else { %>
                    A
                  <% } %>
                </div>
                <div class="author-bio-content">
                  <h5 class="author-bio-name">About the Author</h5>
                  <p class="author-bio-text">
                    <% if (blog.author) { %>
                      <strong><%= blog.author.firstname %> <%= blog.author.lastname || '' %></strong> is a passionate blogger sharing insights and stories.
                    <% } else { %>
                      <strong>Anonymous Author</strong>
                    <% } %>
                  </p>
                </div>
              </div>
            </div>

            <!-- Article Actions -->
            <div class="article-actions">
              <% if (user && blog.author && user._id.toString() === blog.author._id.toString()) { %>
                <a href="/blogs/<%= blog._id %>/edit" class="btn-edit-article">Edit Article</a>
                <button class="btn-delete-article" data-doc="<%= blog._id %>">Delete Article</button>
              <% } %>
            </div>
          </div>
        </article>

        <!-- Sidebar: Similar Posts -->
        <aside class="article-sidebar">
          <div class="sidebar-card">
            <h3 class="sidebar-title">Similar Articles</h3>
            <% if (similarBlogs && similarBlogs.length > 0) { %>
              <div class="similar-posts-list">
                <% similarBlogs.forEach(function(similar) { %>
                  <a href="/blogs/<%= similar._id %>" class="similar-post-item">
                    <div class="similar-post-title"><%= similar.title %></div>
                    <% if (similar.tags && similar.tags.length > 0) { %>
                      <div class="similar-post-tags">
                        <% similar.tags.slice(0, 2).forEach(tag => { %>
                          <span class="small-tag"><%= tag %></span>
                        <% }) %>
                      </div>
                    <% } %>
                  </a>
                <% }) %>
              </div>
            <% } else { %>
              <p class="no-similar">No similar articles found. Check back later!</p>
            <% } %>
          </div>

          <!-- Share Buttons -->
          <div class="sidebar-card">
            <h3 class="sidebar-title">Share</h3>
            <div class="share-buttons">
              <a href="https://twitter.com/intent/tweet?url=<%= encodeURIComponent(articleUrl) %>&text=<%= encodeURIComponent(blog.title) %>" class="share-btn twitter" target="_blank">Twitter</a>
              <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent(articleUrl) %>" class="share-btn facebook" target="_blank">Facebook</a>
              <button class="share-btn copy" onclick="copyToClipboard()">Copy Link</button>
            </div>
          </div>
        </aside>
      </div>
    <% } else { %>
      <div class="article-not-found">
        <h2>Article Not Found</h2>
        <p>The article you're looking for doesn't exist or has been deleted.</p>
        <a href="/blogs" class="btn-back-home">Back to All Articles</a>
      </div>
    <% } %>

    <%- include('partials/footer') %>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="deleteModal">
      <div class="delete-modal-content">
        <div class="delete-modal-header">
          <h2>Delete Article</h2>
          <button class="modal-close" id="closeDeleteModal">&times;</button>
        </div>
        <div class="delete-modal-body">
          <p>Are you sure you want to delete this article?</p>
          <p class="delete-warning">This action cannot be undone. All comments and engagement data will be permanently lost.</p>
        </div>
        <div class="delete-modal-footer">
          <button class="btn-modal-cancel" id="cancelDelete">Cancel</button>
          <button class="btn-modal-delete" id="confirmDelete">Delete Article</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Delete article functionality with modal
    const deleteBtn = document.querySelector('.btn-delete-article');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const closeDeleteModalBtn = document.getElementById('closeDeleteModal');
    let docIdToDelete = null;

    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        docIdToDelete = deleteBtn.getAttribute('data-doc');
        deleteModal.classList.add('active');
      });
    }

    // Close modal when cancel is clicked
    cancelDeleteBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
      docIdToDelete = null;
    });

    // Close modal when X is clicked
    closeDeleteModalBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
      docIdToDelete = null;
    });

    // Close modal when clicking outside
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
        docIdToDelete = null;
      }
    });

    // Confirm delete
    confirmDeleteBtn.addEventListener('click', async () => {
      if (!docIdToDelete) return;
      
      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.textContent = 'Deleting...';

      try {
        const response = await fetch(`/blogs/${docIdToDelete}`, { method: 'DELETE' });
        const data = await response.json();
        window.location.href = data.redirect || '/blogs';
      } catch (err) {
        console.error('Error deleting article:', err);
        alert('Failed to delete article. Please try again.');
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.textContent = 'Delete Article';
        deleteModal.classList.remove('active');
        docIdToDelete = null;
      }
    });

    // Copy link to clipboard with toast notification
    function copyToClipboard() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copied to clipboard!');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>