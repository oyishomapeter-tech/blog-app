<!DOCTYPE html>
<html lang="en">
<%- include('partials/header') %>
<body>
  <div class="page-wrapper">
    <% if (blog) { %>
      <!-- Hero Article Header -->
      <div class="article-hero-section">
        <div class="article-hero-bg"></div>
        <div class="article-hero-content">
          <h1 class="article-title"><%= blog.title %></h1>
          <div class="article-meta">
            <div class="author-info">
              <div class="author-avatar">
                <% if (blog.author) { %>
                  <%= (blog.author.firstname.charAt(0) + (blog.author.lastname ? blog.author.lastname.charAt(0) : '')).toUpperCase() %>
                <% } else { %>
                  A
                <% } %>
              </div>
              <div class="author-details">
                <p class="author-name">
                  <% if (blog.author) { %>
                    <%= blog.author.firstname %> <%= blog.author.lastname || '' %>
                  <% } else { %>
                    Anonymous
                  <% } %>
                </p>
                <p class="article-date">
                  <%= new Date(blog.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                </p>
              </div>
              <!-- Follow button: show only if viewing someone else's post -->
              <% if (user && blog.author && user._id.toString() !== blog.author._id.toString()) { %>
                <button class="btn-follow <% if (isFollowing) { %>following<% } %>" data-user-id="<%= blog.author._id %>" data-username="<%= blog.author.firstname %>">
                  <span class="follow-text"><% if (isFollowing) { %>Following<% } else { %>Follow<% } %></span>
                </button>
              <% } %>
            </div>
            <div class="article-read-time">
              <span class="read-time-badge"><%= Math.ceil(blog.body.split(/\s+/).length / 200) %> min read</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="article-container">
        <!-- Article Body (Left) -->
        <article class="article-content">
          <!-- Featured Image (if available) -->
          <% 
            let featuredImg = null;
            if (blog.imageUrl) { 
              featuredImg = blog.imageUrl; 
            } else if (blog.body) {
              var m = blog.body.match(/<img[^>]+src=["']([^"']+)["']/i);
              if (m) featuredImg = m[1];
            }
          %>
          <% if (featuredImg) { %>
            <figure class="article-featured-image">
              <img src="<%= featuredImg %>" alt="<%= blog.title %>">
            </figure>
          <% } %>

          <!-- Article Body -->
          <div class="article-body">
            <%- blog.body %>
          </div>

          <!-- Article Footer -->
          <div class="article-footer">
            <div class="engagement-bar">
              <button class="btn-like" data-id="<%= blog._id %>">
                <span class="like-icon">‚ù§</span>
                <span class="like-count"><%= blog.likes ? blog.likes.length : 0 %></span>
              </button>
              <button class="btn-comments-toggle">
                üí¨ <span class="comments-count"><%= blog.comments ? blog.comments.length : 0 %></span>
              </button>
              <button class="btn-share" data-id="<%= blog._id %>">üîó <span class="share-count"><%= blog.shares || 0 %></span></button>
            </div>

            <div class="article-tags">
              <% if (blog.tags && blog.tags.length > 0) { %>
                <h4>Tags</h4>
                <div class="tags-list">
                  <% blog.tags.forEach(tag => { %>
                    <span class="tag"><%= tag %></span>
                  <% }) %>
                </div>
              <% } %>
            </div>

            <!-- Author Bio Section -->
            <div class="author-bio-section">
              <div class="author-bio-card">
                <div class="author-bio-avatar">
                  <% if (blog.author) { %>
                    <%= (blog.author.firstname.charAt(0) + (blog.author.lastname ? blog.author.lastname.charAt(0) : '')).toUpperCase() %>
                  <% } else { %>
                    A
                  <% } %>
                </div>
                <div class="author-bio-content">
                  <h5 class="author-bio-name">About the Author</h5>
                  <p class="author-bio-text">
                    <% if (blog.author) { %>
                      <strong><%= blog.author.firstname %> <%= blog.author.lastname || '' %></strong> is a passionate blogger sharing insights and stories.
                    <% } else { %>
                      <strong>Anonymous Author</strong>
                    <% } %>
                  </p>
                </div>
              </div>
            </div>

            <!-- Article Actions -->
            <div class="article-actions">
              <% if (user && blog.author && user._id.toString() === blog.author._id.toString()) { %>
                <a href="/blogs/<%= blog._id %>/edit" class="btn-edit-article">Edit Article</a>
                <button class="btn-delete-article" data-doc="<%= blog._id %>">Delete Article</button>
              <% } %>
            </div>

            <!-- Comments Section -->
            <div class="comments-section" id="commentsSection">
              <h4>Comments (<span id="commentsCount"><%= blog.comments ? blog.comments.length : 0 %></span>)</h4>
              <div id="commentsList">
                <% if (blog.comments && blog.comments.length > 0) { %>
                  <% blog.comments.forEach(function(c){ %>
                    <div class="comment-item">
                      <div class="comment-author"><%= c.author ? (c.author.firstname + ' ' + (c.author.lastname || '')) : 'Anonymous' %></div>
                      <div class="comment-body"><%= c.body %></div>
                      <div class="comment-meta"><%= new Date(c.createdAt).toLocaleString() %></div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <p class="no-comments">No comments yet. Be the first to comment!</p>
                <% } %>
              </div>

              <% if (user) { %>
                <form id="commentForm">
                  <textarea name="body" id="commentBody" placeholder="Write a comment..." required></textarea>
                  <button type="submit" class="btn-post-comment">Post Comment</button>
                </form>
              <% } else { %>
                <p><a href="/login">Log in</a> to post a comment.</p>
              <% } %>
            </div>
          </div>
        </article>

        <!-- Sidebar: Similar Posts -->
        <aside class="article-sidebar">
          <div class="sidebar-card">
            <h3 class="sidebar-title">Similar Articles</h3>
            <% if (similarBlogs && similarBlogs.length > 0) { %>
              <div class="similar-posts-list">
                <% similarBlogs.forEach(function(similar) { %>
                  <a href="/blogs/<%= similar._id %>" class="similar-post-item">
                    <div class="similar-post-title"><%= similar.title %></div>
                    <% if (similar.tags && similar.tags.length > 0) { %>
                      <div class="similar-post-tags">
                        <% similar.tags.slice(0, 2).forEach(tag => { %>
                          <span class="small-tag"><%= tag %></span>
                        <% }) %>
                      </div>
                    <% } %>
                  </a>
                <% }) %>
              </div>
            <% } else { %>
              <p class="no-similar">No similar articles found. Check back later!</p>
            <% } %>
          </div>

          <!-- Share Buttons -->
          <div class="sidebar-card">
            <h3 class="sidebar-title">Share</h3>
            <div class="share-buttons">
              <a href="https://twitter.com/intent/tweet?url=<%= encodeURIComponent(articleUrl) %>&text=<%= encodeURIComponent(blog.title) %>" class="share-btn twitter" target="_blank">Twitter</a>
              <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent(articleUrl) %>" class="share-btn facebook" target="_blank">Facebook</a>
              <button class="share-btn copy" onclick="copyToClipboard()">Copy Link</button>
            </div>
          </div>
        </aside>
      </div>
    <% } else { %>
      <div class="article-not-found">
        <h2>Article Not Found</h2>
        <p>The article you're looking for doesn't exist or has been deleted.</p>
        <a href="/blogs" class="btn-back-home">Back to All Articles</a>
      </div>
    <% } %>

    <%- include('partials/footer') %>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="deleteModal">
      <div class="delete-modal-content">
        <div class="delete-modal-header">
          <h2>Delete Article</h2>
          <button class="modal-close" id="closeDeleteModal">&times;</button>
        </div>
        <div class="delete-modal-body">
          <p>Are you sure you want to delete this article?</p>
          <p class="delete-warning">This action cannot be undone. All comments and engagement data will be permanently lost.</p>
        </div>
        <div class="delete-modal-footer">
          <button class="btn-modal-cancel" id="cancelDelete">Cancel</button>
          <button class="btn-modal-delete" id="confirmDelete">Delete Article</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Delete article functionality with modal
    const deleteBtn = document.querySelector('.btn-delete-article');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    const closeDeleteModalBtn = document.getElementById('closeDeleteModal');
    let docIdToDelete = null;

    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        docIdToDelete = deleteBtn.getAttribute('data-doc');
        deleteModal.classList.add('active');
      });
    }

    // Close modal when cancel is clicked
    cancelDeleteBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
      docIdToDelete = null;
    });

    // Close modal when X is clicked
    closeDeleteModalBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
      docIdToDelete = null;
    });

    // Close modal when clicking outside
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
        docIdToDelete = null;
      }
    });

    // Confirm delete
    confirmDeleteBtn.addEventListener('click', async () => {
      if (!docIdToDelete) return;
      
      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.textContent = 'Deleting...';

      try {
        const response = await fetch(`/blogs/${docIdToDelete}`, { method: 'DELETE' });
        const data = await response.json();
        window.location.href = data.redirect || '/blogs';
      } catch (err) {
        console.error('Error deleting article:', err);
        alert('Failed to delete article. Please try again.');
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.textContent = 'Delete Article';
        deleteModal.classList.remove('active');
        docIdToDelete = null;
      }
    });

    // Copy link to clipboard with toast notification
    function copyToClipboard() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copied to clipboard!');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Like button handler
    (function(){
      const likeBtn = document.querySelector('.btn-like');
      if (!likeBtn) return;
      const blogId = likeBtn.getAttribute('data-id');
      const likeCountEl = likeBtn.querySelector('.like-count');
      likeBtn.addEventListener('click', async () => {
        try {
          likeBtn.disabled = true;
          const res = await fetch(`/blogs/${blogId}/like`, { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            likeCountEl.textContent = data.likesCount;
            if (data.liked) likeBtn.classList.add('liked'); else likeBtn.classList.remove('liked');
          } else {
            showToast(data.error || 'Could not like post', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Network error', 'error');
        } finally {
          likeBtn.disabled = false;
        }
      });
    })();

    // Comment form handler
    (function(){
      const commentForm = document.getElementById('commentForm');
      if (!commentForm) return;
      const commentsList = document.getElementById('commentsList');
      const commentsCount = document.getElementById('commentsCount');
      const commentBody = document.getElementById('commentBody');
      const blogId = '<%= blog._id %>';
      commentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = commentBody.value.trim();
        if (!body) return;
        try {
          const res = await fetch(`/blogs/${blogId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ body })
          });
          const data = await res.json();
          if (res.ok) {
            // prepend comment
            const c = data.comment;
            const div = document.createElement('div');
            div.className = 'comment-item';
            div.innerHTML = `<div class="comment-author">${c.author ? (c.author.firstname + ' ' + (c.author.lastname || '')) : 'Anonymous'}</div><div class="comment-body">${c.body}</div><div class="comment-meta">${new Date(c.createdAt).toLocaleString()}</div>`;
            // remove 'no comments' placeholder if present
            const placeholder = commentsList.querySelector('.no-comments');
            if (placeholder) placeholder.remove();
            commentsList.insertBefore(div, commentsList.firstChild);
            // update counts
            const count = data.commentsCount;
            commentsCount.textContent = count;
            const commentsCountEls = document.querySelectorAll('.comments-count');
            commentsCountEls.forEach(el => el.textContent = count);
            commentBody.value = '';
            showToast('Comment posted');
          } else {
            showToast(data.error || 'Failed to post comment', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Network error', 'error');
        }
      });
    })();

    // Share buttons: increment share count before opening
    (function(){
      const shareBtns = document.querySelectorAll('.share-btn');
      const shareCountEl = document.querySelector('.share-count');
      const blogId = '<%= blog._id %>';
      shareBtns.forEach(btn => {
        if (btn.tagName.toLowerCase() === 'a') {
          btn.addEventListener('click', async (e) => {
            try {
              // increment share count (fire-and-forget)
              await fetch(`/blogs/${blogId}/share`, { method: 'POST' });
            } catch (err) {
              // ignore
            }
          });
        }
      });

      // overwrite copyToClipboard to also increment share count
      const originalCopy = copyToClipboard;
      window.copyToClipboard = async function() {
        try {
          await fetch(`/blogs/${blogId}/share`, { method: 'POST' });
        } catch (err) {
          // ignore
        }
        originalCopy();
      };
    })();

    // Follow button handler
    (function(){
      const followBtn = document.querySelector('.btn-follow');
      if (!followBtn) return;
      const userId = followBtn.getAttribute('data-user-id');
      const username = followBtn.getAttribute('data-username');
      const followText = followBtn.querySelector('.follow-text');

      followBtn.addEventListener('click', async (e) => {
        try {
          followBtn.disabled = true;
          const res = await fetch(`/users/${userId}/follow`, { method: 'POST' });
          const data = await res.json();
          if (res.ok) {
            // Toggle button state
            if (data.following) {
              followBtn.classList.add('following');
              followText.textContent = 'Following';
              showToast(`Following ${username}`);
            } else {
              followBtn.classList.remove('following');
              followText.textContent = 'Follow';
              showToast(`Unfollowed ${username}`);
            }
          } else {
            showToast(data.error || 'Could not follow user', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Network error', 'error');
        } finally {
          followBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>